# Use official Python image
FROM python:3.12-slim-bookworm

# Set working directory
WORKDIR /app

# Security: Update all packages and install required dependencies
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends gcc postgresql-client && \
    rm -rf /var/lib/apt/lists/*

# Copy Python requirements
COPY requirements.txt .

# Install dependencies
RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install uvicorn

# Copy app code and Alembic
COPY app /app/app
COPY app/alembic /app/alembic
COPY app/alembic.ini /app/

# Expose dev port
EXPOSE 8000

# Run app in development mode with hot reload
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]


# # =========================
# # Stage 1: Builder
# # =========================
# FROM python:3.12-slim as builder

# WORKDIR /app

# # Install build tools for compiling deps (only in build stage)
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     gcc libpq-dev \
#     && rm -rf /var/lib/apt/lists/*

# # Copy requirements first for caching
# COPY requirements.txt .

# # Install dependencies into a virtual environment
# RUN python -m venv /opt/venv \
#     && /opt/venv/bin/pip install --upgrade pip \
#     && /opt/venv/bin/pip install --no-cache-dir -r requirements.txt uvicorn

# # =========================
# # Stage 2: Development Runner
# # =========================


# # # Use official Python image
# # FROM python:3.12-slim-bullseye

# # RUN apt-get update && apt-get dist-upgrade -y \
# #     && apt-get install -y --no-install-recommends gcc postgresql-client \
# #     && rm -rf /var/lib/apt/lists/*




# # # Security: Update all packages to latest versions
# # RUN apt-get update && \
# #     apt-get upgrade -y && \
# #     apt-get install -y --no-install-recommends gcc postgresql-client && \
# #     rm -rf /var/lib/apt/lists/*

# # # Set working directory
# # WORKDIR /app

# # # Update system and install required packages
# # RUN apt-get update && apt-get upgrade -y && \
# #     apt-get install -y gcc postgresql-client && \
# #     rm -rf /var/lib/apt/lists/*

# # # Copy Python requirements
# # COPY app/requirements.txt .

# # # Install dependencies
# # RUN pip install --upgrade pip && pip install -r requirements.txt && pip install uvicorn

# # # Copy app code and Alembic
# # COPY app /app/app
# # COPY app/alembic /app/alembic
# # COPY app/alembic.ini /app/

# # # Expose dev port
# # EXPOSE 8000

# # # Run app in development mode with hot reload
# # CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]



# # # # Use official Python image
# # # FROM python:3.10-slim-bookworm 


# # # # Set working directory in container
# # # WORKDIR /app

# # # RUN apt-get update && apt-get upgrade -y && apt-get install -y gcc postgresql-client && rm -rf /var/lib/apt/lists/*


# # # # Install system dependencies (Postgres client, gcc)
# # # RUN apt-get update && apt-get install -y \
# # #     gcc \
# # #     postgresql-client \
# # #     && rm -rf /var/lib/apt/lists/*

# # # # Copy requirements from root folder
# # # COPY requirements.txt .

# # # # Install Python dependencies
# # # RUN pip install --upgrade pip && pip install -r requirements.txt && pip install uvicorn

# # # # Copy app folder for hot reload
# # # COPY app /app/app

# # # # Copy Alembic migrations and config
# # # COPY app/alembic /app/alembic
# # # COPY app/alembic.ini /app/

# # # # Expose port for development
# # # EXPOSE 8000

# # # # Run app in dev mode with reload
# # # CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]


