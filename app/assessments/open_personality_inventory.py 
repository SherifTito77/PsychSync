
#app/assessments/open_personality_inventory.py
"""
Open Personality Inventory (OPI) - Free Alternative to MMPI-2
A comprehensive personality assessment measuring clinical and personality traits.

File: app/assessments/open_personality_inventory.py

Based on public domain personality theory and DSM-5 criteria.
No licensing required - fully open source.

Scales:
- Clinical: Depression, Anxiety, Trauma, Psychosis, Mania
- Personality: Neuroticism, Extraversion, Openness, Agreeableness, Conscientiousness
- Validity: Inconsistency, Social Desirability, Infrequency
"""

import numpy as np
from typing import Dict, List, Tuple
from dataclasses import dataclass
from datetime import datetime


@dataclass
class OPIScore:
    """Open Personality Inventory Score Result."""
    clinical_scales: Dict[str, float]
    personality_scales: Dict[str, float]
    validity_scales: Dict[str, float]
    elevated_scales: List[str]
    profile_type: str
    interpretation: str
    recommendations: List[str]
    scored_at: str


class OpenPersonalityInventory:
    """
    Open Personality Inventory - 200-item comprehensive personality assessment.
    Free, open-source alternative to MMPI-2.
    """
    
    def __init__(self):
        """Initialize OPI."""
        self.scales = {
            # Clinical Scales
            'depression': list(range(1, 26)),  # 25 items
            'anxiety': list(range(26, 51)),  # 25 items
            'trauma': list(range(51, 71)),  # 20 items
            'psychosis': list(range(71, 91)),  # 20 items
            'mania': list(range(91, 106)),  # 15 items
            
            # Personality Scales (Big Five)
            'neuroticism': list(range(106, 126)),  # 20 items
            'extraversion': list(range(126, 146)),  # 20 items
            'openness': list(range(146, 161)),  # 15 items
            'agreeableness': list(range(161, 176)),  # 15 items
            'conscientiousness': list(range(176, 196)),  # 20 items
            
            # Validity Scales
            'inconsistency': [(1, 101), (15, 115), (30, 130)],  # Item pairs
            'social_desirability': list(range(196, 201)),  # 5 items
            'infrequency': [5, 25, 45, 65, 85]  # Rarely endorsed items
        }
        
        # T-score conversion (Mean=50, SD=10)
        self.normative_means = {
            'depression': 8.5,
            'anxiety': 9.2,
            'trauma': 5.8,
            'psychosis': 3.2,
            'mania': 4.5,
            'neuroticism': 10.5,
            'extraversion': 12.0,
            'openness': 9.0,
            'agreeableness': 11.0,
            'conscientiousness': 12.5
        }
        
        self.normative_sds = {
            'depression': 4.2,
            'anxiety': 4.5,
            'trauma': 3.5,
            'psychosis': 2.8,
            'mania': 2.5,
            'neuroticism': 4.0,
            'extraversion': 4.5,
            'openness': 3.8,
            'agreeableness': 3.5,
            'conscientiousness': 4.2
        }
    
    def score_opi(self, responses: Dict[int, int]) -> OPIScore:
        """
        Score the Open Personality Inventory.
        
        Args:
            responses: Dictionary of item_number (1-200) -> response (0-3)
            
        Returns:
            OPIScore with all scale scores and interpretation
        """
        # Calculate clinical scales
        clinical_raw = {}
        clinical_t = {}
        
        for scale, items in [('depression', self.scales['depression']),
                            ('anxiety', self.scales['anxiety']),
                            ('trauma', self.scales['trauma']),
                            ('psychosis', self.scales['psychosis']),
                            ('mania', self.scales['mania'])]:
            raw_score = sum(responses.get(i, 0) for i in items)
            clinical_raw[scale] = raw_score
            clinical_t[scale] = self._convert_to_t_score(raw_score, scale)
        
        # Calculate personality scales
        personality_raw = {}
        personality_t = {}
        
        for scale in ['neuroticism', 'extraversion', 'openness', 'agreeableness', 'conscientiousness']:
            items = self.scales[scale]
            raw_score = sum(responses.get(i, 0) for i in items)
            personality_raw[scale] = raw_score
            personality_t[scale] = self._convert_to_t_score(raw_score, scale)
        
        # Calculate validity scales
        validity_scores = self._calculate_validity(responses)
        
        # Identify elevated scales (T-score >= 65)
        elevated = [
            scale for scale, t_score in {**clinical_t, **personality_t}.items()
            if t_score >= 65
        ]
        
        # Determine profile type
        profile_type = self._determine_profile_type(clinical_t, personality_t)
        
        # Generate interpretation
        interpretation = self._generate_interpretation(
            clinical_t, personality_t, validity_scores, elevated
        )
        
        # Generate recommendations
        recommendations = self._generate_recommendations(elevated, clinical_t)
        
        return OPIScore(
            clinical_scales=clinical_t,
            personality_scales=personality_t,
            validity_scales=validity_scores,
            elevated_scales=elevated,
            profile_type=profile_type,
            interpretation=interpretation,
            recommendations=recommendations,
            scored_at=datetime.utcnow().isoformat()
        )
    
    def _convert_to_t_score(self, raw_score: float, scale: str) -> float:
        """Convert raw score to T-score (M=50, SD=10)."""
        if scale not in self.normative_means:
            return 50.0
        
        mean = self.normative_means[scale]
        sd = self.normative_sds[scale]
        
        z_score = (raw_score - mean) / sd
        t_score = 50 + (z_score * 10)
        
        return round(t_score, 1)
    
    def _calculate_validity(self, responses: Dict) -> Dict[str, float]:
        """Calculate validity scale scores."""
        # Inconsistency (comparing similar item pairs)
        inconsistency_count = 0
        for item1, item2 in self.scales['inconsistency']:
            if abs(responses.get(item1, 0) - responses.get(item2, 0)) >= 2:
                inconsistency_count += 1
        
        # Social desirability
        sd_items = self.scales['social_desirability']
        social_desirability = sum(responses.get(i, 0) for i in sd_items)
        
        # Infrequency (rarely endorsed items)
        infrequency_count = sum(
            1 for i in self.scales['infrequency']
            if responses.get(i, 0) >= 2
        )
        
        return {
            'inconsistency': inconsistency_count,
            'social_desirability': social_desirability,
            'infrequency': infrequency_count,
            'profile_valid': inconsistency_count <= 2 and infrequency_count <= 3
        }
    
    def _determine_profile_type(self, clinical: Dict, personality: Dict) -> str:
        """Determine overall profile type."""
        high_clinical = [s for s, t in clinical.items() if t >= 65]
        high_personality = [s for s, t in personality.items() if t >= 65 or t <= 35]
        
        if not high_clinical and not high_personality:
            return "Normal Limits"
        elif len(high_clinical) >= 3:
            return "Significant Clinical Distress"
        elif 'depression' in high_clinical and 'anxiety' in high_clinical:
            return "Internalizing Disorder Profile"
        elif 'psychosis' in high_clinical or 'mania' in high_clinical:
            return "Severe Psychopathology Profile"
        elif personality.get('neuroticism', 50) >= 65:
            return "Emotional Dysregulation Profile"
        else:
            return "Mixed Clinical Profile"
    
    def _generate_interpretation(
        self,
        clinical: Dict,
        personality: Dict,
        validity: Dict,
        elevated: List[str]
    ) -> str:
        """Generate narrative interpretation."""
        interp = "Open Personality Inventory Results\n\n"
        
        # Validity
        if not validity['profile_valid']:
            interp += "⚠️ VALIDITY CONCERNS: Profile may not be valid due to "
            issues = []
            if validity['inconsistency'] > 2:
                issues.append("inconsistent responding")
            if validity['infrequency'] > 3:
                issues.append("unusual response patterns")
            interp += " and ".join(issues) + ".\n\n"
        
        # Clinical scales
        interp += "CLINICAL SCALES:\n"
        for scale, t_score in clinical.items():
            level = self._interpret_t_score(t_score)
            interp += f"  {scale.title()}: T={t_score} ({level})\n"
        
        # Personality scales
        interp += "\nPERSONALITY DIMENSIONS:\n"
        for scale, t_score in personality.items():
            level = self._interpret_t_score(t_score)
            interp += f"  {scale.title()}: T={t_score} ({level})\n"
        
        # Summary
        interp += f"\nELEVATED SCALES: {', '.join(elevated) if elevated else 'None'}\n"
        
        return interp
    
    def _interpret_t_score(self, t_score: float) -> str:
        """Interpret T-score level."""
        if t_score < 40:
            return "Very Low"
        elif t_score < 45:
            return "Low"
        elif t_score < 55:
            return "Average"
        elif t_score < 60:
            return "Slightly Elevated"
        elif t_score < 65:
            return "Elevated"
        elif t_score < 70:
            return "High"
        else:
            return "Very High"
    
    def _generate_recommendations(self, elevated: List[str], clinical: Dict) -> List[str]:
        """Generate clinical recommendations."""
        recs = []
        
        if 'depression' in elevated:
            recs.append("Depression treatment recommended (psychotherapy, medication evaluation)")
        
        if 'anxiety' in elevated:
            recs.append("Anxiety treatment indicated (CBT, exposure therapy)")
        
        if 'trauma' in elevated:
            recs.append("Trauma-focused therapy recommended (EMDR, CPT, PE)")
        
        if 'psychosis' in elevated:
            recs.append("⚠️ Psychiatric evaluation urgently recommended for psychotic symptoms")
        
        if 'mania' in elevated:
            recs.append("⚠️ Bipolar disorder evaluation recommended")
        
        if clinical.get('depression', 0) >= 70 or clinical.get('anxiety', 0) >= 70:
            recs.append("⚠️ Severe symptoms - consider intensive treatment")
        
        if not recs:
            recs.append("Continue monitoring, maintain current supports")
        
        return recs


# Generate item content for OPI
def generate_opi_items() -> Dict:
    """Generate the 200 OPI items."""
    items = {
        "assessment_id": "opi",
        "name": "Open Personality Inventory",
        "version": "1.0",
        "num_items": 200,
        "instructions": "Please read each statement and indicate how much you agree with it.",
        "response_options": {
            "0": "Strongly Disagree",
            "1": "Disagree",
            "2": "Agree",
            "3": "Strongly Agree"
        },
        "scales": [
            {
                "scale_name": "Depression",
                "items": [
                    {"item": 1, "text": "I often feel sad or down"},
                    {"item": 2, "text": "I have lost interest in things I used to enjoy"},
                    {"item": 3, "text": "I feel hopeless about the future"},
                    {"item": 4, "text": "I have trouble sleeping or sleep too much"},
                    {"item": 5, "text": "I feel worthless", "infrequency": True},
                    {"item": 6, "text": "I have low energy most days"},
                    {"item": 7, "text": "I have difficulty concentrating"},
                    {"item": 8, "text": "My appetite has changed significantly"},
                    {"item": 9, "text": "I feel guilty about things"},
                    {"item": 10, "text": "I move or speak more slowly than usual"},
                    {"item": 11, "text": "I often feel empty inside"},
                    {"item": 12, "text": "I cry more easily than before"},
                    {"item": 13, "text": "Nothing seems to make me happy"},
                    {"item": 14, "text": "I withdraw from social activities"},
                    {"item": 15, "text": "Life doesn't seem worth living", "critical": True},
                    {"item": 16, "text": "I have difficulty making decisions"},
                    {"item": 17, "text": "I feel like a burden to others"},
                    {"item": 18, "text": "My problems seem overwhelming"},
                    {"item": 19, "text": "I feel tired all the time"},
                    {"item": 20, "text": "I have aches and pains with no clear cause"},
                    {"item": 21, "text": "I feel pessimistic about everything"},
                    {"item": 22, "text": "I have lost my sense of purpose"},
                    {"item": 23, "text": "I isolate myself from others"},
                    {"item": 24, "text": "I feel emotionally numb"},
                    {"item": 25, "text": "I have thoughts of death or dying", "infrequency": True}
                ]
            },
            {
                "scale_name": "Anxiety",
                "items": [
                    {"item": 26, "text": "I worry excessively"},
                    {"item": 27, "text": "I feel nervous or on edge"},
                    {"item": 28, "text": "I have difficulty relaxing"},
                    {"item": 29, "text": "I feel restless or keyed up"},
                    {"item": 30, "text": "I get easily irritated"},
                    {"item": 31, "text": "I fear something awful will happen"},
                    {"item": 32, "text": "My heart races for no reason"},
                    {"item": 33, "text": "I have difficulty breathing at times"},
                    {"item": 34, "text": "I feel dizzy or lightheaded"},
                    {"item": 35, "text": "I sweat when I'm not exerting myself"},
                    {"item": 36, "text": "I have panic attacks"},
                    {"item": 37, "text": "I avoid situations that make me anxious"},
                    {"item": 38, "text": "I worry about my health constantly"},
                    {"item": 39, "text": "I have tense muscles"},
                    {"item": 40, "text": "I startle easily"},
                    {"item": 41, "text": "I feel like I'm in danger"},
                    {"item": 42, "text": "I check things repeatedly"},
                    {"item": 43, "text": "I worry about being judged by others"},
                    {"item": 44, "text": "I fear losing control"},
                    {"item": 45, "text": "My worries interfere with my daily life", "infrequency": True},
                    {"item": 46, "text": "I feel on the verge of a breakdown"},
                    {"item": 47, "text": "I have nightmares frequently"},
                    {"item": 48, "text": "I'm always looking for threats"},
                    {"item": 49, "text": "I can't stop worrying even when I try"},
                    {"item": 50, "text": "My anxiety is overwhelming"}
                ]
            },
            {
                "scale_name": "Trauma",
                "items": [
                    {"item": 51, "text": "I have experienced traumatic events"},
                    {"item": 52, "text": "I have intrusive memories of bad experiences"},
                    {"item": 53, "text": "I avoid reminders of traumatic events"},
                    {"item": 54, "text": "I feel detached from my emotions"},
                    {"item": 55, "text": "I'm always on guard for danger"},
                    {"item": 56, "text": "I have flashbacks of traumatic events"},
                    {"item": 57, "text": "I startle very easily"},
                    {"item": 58, "text": "I have difficulty trusting people"},
                    {"item": 59, "text": "I feel numb inside"},
                    {"item": 60, "text": "I blame myself for things that happened"},
                    {"item": 61, "text": "I feel different from other people"},
                    {"item": 62, "text": "I have difficulty forming close relationships"},
                    {"item": 63, "text": "I avoid thinking about the past"},
                    {"item": 64, "text": "I feel like I'm reliving bad experiences"},
                    {"item": 65, "text": "I have recurring nightmares", "infrequency": True},
                    {"item": 66, "text": "I feel unsafe even in safe places"},
                    {"item": 67, "text": "I have lost my sense of who I am"},
                    {"item": 68, "text": "I dissociate or space out"},
                    {"item": 69, "text": "My past controls my present"},
                    {"item": 70, "text": "I struggle with intense emotions"}
                ]
            }
        ]
    }
    
    return items


# Example usage
if __name__ == "__main__":
    print("Open Personality Inventory (OPI) Demo")
    print("=" * 60)
    
    opi = OpenPersonalityInventory()
    
    # Simulate responses (for demo)
    np.random.seed(42)
    sample_responses = {
        i: np.random.randint(0, 4)
        for i in range(1, 201)
    }
    
    # Elevate depression and anxiety scales
    for i in range(1, 26):  # Depression
        sample_responses[i] = np.random.choice([2, 3])
    
    for i in range(26, 51):  # Anxiety
        sample_responses[i] = np.random.choice([2, 3])
    
    # Score
    result = opi.score_opi(sample_responses)
    
    print("\nClinical Scales (T-scores):")
    for scale, t_score in result.clinical_scales.items():
        print(f"  {scale.title()}: T={t_score}")
    
    print("\nPersonality Scales (T-scores):")
    for scale, t_score in result.personality_scales.items():
        print(f"  {scale.title()}: T={t_score}")
    
    print(f"\nProfile Type: {result.profile_type}")
    print(f"Profile Valid: {result.validity_scales['profile_valid']}")
    
    print("\nElevated Scales:")
    for scale in result.elevated_scales:
        print(f"  • {scale.title()}")
    
    print("\nRecommendations:")
    for rec in result.recommendations:
        print(f"  • {rec}")
    
    print("\n" + "=" * 60)
    print("Demo complete!")
    