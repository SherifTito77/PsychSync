import React, { useState, useEffect } from 'react';
import {
  Globe,
  ChevronDown
  Check
} from 'lucide-react';
import Button from './Button';
import { Card } from '../common/card';

interface Language {
  code: string;
  name: string;
  flag: string;
  rtl: boolean;
}

interface LanguageSelectorProps {
  className?: string;
  onLanguageChange?: (language: Language) => void;
}

const languages: Language[] = [
  { code: 'en', name: 'English', flag: 'ğŸ‡ºğŸ‡¸', rtl: false },
  { code: 'es', name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', rtl: false },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', rtl: false },
  { code: 'de', name: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª', rtl: false },
  { code: 'pt', name: 'PortuguÃªs', flag: 'ğŸ‡§ğŸ‡·', rtl: false },
  { code: 'it', name: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹', rtl: false },
  { code: 'nl', name: 'Nederlands', flag: 'ğŸ‡³ğŸ‡±', rtl: false },
  { code: 'pl', name: 'Polski', flag: 'ğŸ‡µğŸ‡±', rtl: false },
  { code: 'ja', name: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ', rtl: false },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³', rtl: false },
  { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·', rtl: false },
  { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦', rtl: true },
  { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ğŸ‡®ğŸ‡³', rtl: false },
  { code: 'ru', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', flag: 'ğŸ‡·ğŸ‡º', rtl: false },
  { code: 'tr', name: 'TÃ¼rkÃ§e', flag: 'ğŸ‡¹ğŸ‡·', rtl: false }
];

const translations: Record<string, Record<string, string>> = {
  // English
  en: {
    select_language: 'Select Language',
    current_language: 'Current Language',
    compliance: 'Compliance',
    training: 'Training',
    feedback: 'Feedback',
    rights: 'Rights',
    dashboard: 'Dashboard',
    analytics: 'Analytics',
    settings: 'Settings',
    logout: 'Logout'
  },
  // Spanish
  es: {
    select_language: 'Seleccionar Idioma',
    current_language: 'Idioma Actual',
    compliance: 'Cumplimiento',
    training: 'CapacitaciÃ³n',
    feedback: 'Comentarios',
    rights: 'Derechos',
    dashboard: 'Panel de Control',
    analytics: 'AnÃ¡lisis',
    settings: 'ConfiguraciÃ³n',
    logout: 'Cerrar SesiÃ³n'
  },
  // French
  fr: {
    select_language: 'SÃ©lectionner la Langue',
    current_language: 'Langue Actuelle',
    compliance: 'ConformitÃ©',
    training: 'Formation',
    feedback: 'Commentaires',
    rights: 'Droits',
    dashboard: 'Tableau de Bord',
    analytics: 'Analytique',
    settings: 'ParamÃ¨tres',
    logout: 'DÃ©connexion'
  },
  // German
  de: {
    select_language: 'Sprache AuswÃ¤hlen',
    current_language: 'Aktuelle Sprache',
    compliance: 'Einhaltung',
    training: 'Schulung',
    feedback: 'Feedback',
    rights: 'Rechte',
    dashboard: 'Dashboard',
    analytics: 'Analytik',
    settings: 'Einstellungen',
    logout: 'Abmelden'
  },
  // Portuguese
  pt: {
    select_language: 'Selecionar Idioma',
    current_language: 'Idioma Atual',
    compliance: 'Conformidade',
    training: 'Treinamento',
    feedback: 'Feedback',
    rights: 'Direitos',
    dashboard: 'Painel',
    analytics: 'AnÃ¡lise',
    settings: 'ConfiguraÃ§Ãµes',
    logout: 'Sair'
  },
  // Japanese
  ja: {
    select_language: 'è¨€èªã‚’é¸æŠ',
    current_language: 'ç¾åœ¨ã®è¨€èª',
    compliance: 'ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹',
    training: 'ç ”ä¿®',
    feedback: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯',
    rights: 'æ¨©åˆ©',
    dashboard: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
    analytics: 'åˆ†æ',
    settings: 'è¨­å®š',
    logout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
  },
  // Chinese
  zh: {
    select_language: 'é€‰æ‹©è¯­è¨€',
    current_language: 'å½“å‰è¯­è¨€',
    compliance: 'åˆè§„',
    training: 'åŸ¹è®­',
    feedback: 'åé¦ˆ',
    rights: 'æƒåˆ©',
    dashboard: 'ä»ªè¡¨æ¿',
    analytics: 'åˆ†æ',
    settings: 'è®¾ç½®',
    logout: 'é€€å‡º'
  },
  // Arabic
  ar: {
    select_language: 'Ø§Ø®ØªØ±Ø§Ø± Ø§Ù„Ù„ØºØ©',
    current_language: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
    compliance: 'Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„',
    training: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨',
    feedback: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
    rights: 'Ø§Ù„Ø­Ù‚ÙˆÙ‚',
    dashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©',
    analytics: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª',
    settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    logout: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'
  }
};

export const LanguageSelector: React.FC<LanguageSelectorProps> = ({ className, onLanguageChange }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [currentLanguage, setCurrentLanguage] = useState<Language>(languages[0]);
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    // Load saved language preference
    const savedLanguage = localStorage.getItem('preferred-language');
    if (savedLanguage) {
      const language = languages.find(lang => lang.code === savedLanguage);
      if (language) {
        setCurrentLanguage(language);
      }
    }
  }, []);

  const handleLanguageSelect = (language: Language) => {
    setCurrentLanguage(language);
    localStorage.setItem('preferred-language', language.code);

    // Update document direction for RTL languages
    document.documentElement.dir = language.rtl ? 'rtl' : 'ltr';
    document.documentElement.lang = language.code;

    if (onLanguageChange) {
      onLanguageChange(language);
    }

    setIsOpen(false);
  };

  const filteredLanguages = languages.filter(lang =>
    lang.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    lang.code.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const translate = (key: string): string => {
    return translations[currentLanguage.code]?.[key] || translations.en[key];
  };

  return (
    <div className={`relative ${className}`}>
      {/* Language Button */}
      <Button
        variant="outline"
        onClick={() => setIsOpen(!isOpen)}
        icon={<Globe className="w-4 h-4" />}
      >
        <div className="flex items-center space-x-2">
          <span className="text-lg">{currentLanguage.flag}</span>
          <span className="hidden sm:inline">{currentLanguage.name}</span>
          <ChevronDown className="w-4 h-4" />
        </div>
      </Button>

      {/* Dropdown */}
      {isOpen && (
        <>
          <div
            className="fixed inset-0 z-40"
            onClick={() => setIsOpen(false)}
          />
          <div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50 max-h-96 overflow-hidden">
            <div className="p-4 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">{translate('select_language')}</h3>

              {/* Search */}
              <div className="relative">
                <input
                  type="text"
                  placeholder={translate('search_language') || 'Search languages...'}
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                />
              </div>
            </div>

            {/* Language List */}
            <div className="overflow-y-auto max-h-64">
              <div className="p-2 space-y-1">
                {filteredLanguages.map((language) => (
                  <button
                    key={language.code}
                    onClick={() => handleLanguageSelect(language)}
                    className="w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <div className="flex items-center space-x-3">
                      <span className="text-xl">{language.flag}</span>
                      <div className="text-left">
                        <p className="font-medium text-gray-900">{language.name}</p>
                        <p className="text-sm text-gray-500">{language.code.toUpperCase()}</p>
                      </div>
                    </div>
                    {currentLanguage.code === language.code && (
                      <Check className="w-5 h-5 text-blue-600" />
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Footer */}
            <div className="p-4 border-t border-gray-200 bg-gray-50">
              <div className="text-xs text-gray-600">
                <p>Language affects the interface text only.</p>
                <p>Legal documents and policies are available in all supported languages.</p>
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

// Translation Hook
export const useTranslation = () => {
  const [currentLanguage, setCurrentLanguage] = useState<Language>(languages[0]);

  useEffect(() => {
    const savedLanguage = localStorage.getItem('preferred-language');
    if (savedLanguage) {
      const language = languages.find(lang => lang.code === savedLanguage);
      if (language) {
        setCurrentLanguage(language);
      }
    }
  }, []);

  const translate = (key: string): string => {
    return translations[currentLanguage.code]?.[key] || translations.en[key];
  };

  const setLanguage = (languageCode: string) => {
    const language = languages.find(lang => lang.code === languageCode);
    if (language) {
      setCurrentLanguage(language);
      localStorage.setItem('preferred-language', languageCode);
      document.documentElement.dir = language.rtl ? 'rtl' : 'ltr';
      document.documentElement.lang = languageCode;
    }
  };

  return {
    currentLanguage,
    translate,
    setLanguage,
    isRTL: currentLanguage.rtl
  };
};

// Format date/time according to locale
export const formatDateTime = (date: Date, locale: string = 'en'): string => {
  try {
    return new Intl.DateTimeFormat(locale, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  } catch {
    return date.toLocaleString();
  }
};

// Format number according to locale
export const formatNumber = (
  number: number,
  locale: string = 'en',
  options?: Intl.NumberFormatOptions
): string => {
  try {
    return new Intl.NumberFormat(locale, options).format(number);
  } catch {
    return number.toString();
  }
};

// Currency formatting
export const formatCurrency = (
  amount: number,
  currency: string = 'USD',
  locale: string = 'en'
): string => {
  try {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency
    }).format(amount);
  } catch {
    return `${currency} ${amount.toFixed(2)}`;
  }
};

// Export all supported languages
export { languages };
export { translations };